(function() {

"use strict";

angular.module("BitriseWorkflowEditor").factory("Step", function(Variable) {

	var Step = function(cvs, userStepConfig, defaultStepConfig) {
		this.cvs = cvs;
		this.steplibSourceURL;
		this.id;
		this.version;
		this.userStepConfig = userStepConfig ? userStepConfig : {};
		this.defaultStepConfig = defaultStepConfig;
	};

	Step.prototype.title = function(newTitle) {
		parameterGetterSetter(this, "title", newTitle);
	};

	Step.prototype.summary = function(newSummary) {
		parameterGetterSetter(this, "summary", newSummary);
	};

	Step.prototype.description = function(newDescription) {
		parameterGetterSetter(this, "description", newDescription);
	};

	Step.prototype.sourceURL = function(newSourceURL) {
		parameterGetterSetter(this, "source_url", newSourceURL);
	};

	Step.prototype.iconURL = function(newIconURL) {
		parameterGetterSetter(this, "icon_url", newIconURL);
	};

	Step.prototype.typeTags = function(newTypeTags) {
		parameterGetterSetter(this, "type_tags", newTypeTags);
	};

	Step.prototype.inputs = function() {
		var self = this;

		return _.map(this.defaultStepConfig.input, function(aDefaultInputConfig) {
			var defaultKey = Variable.keyFromVariableConfig(aDefaultInputConfig);

			var userInputConfig = _.find(self.userStepConfig.inputs, function(aUserInputConfig) {
				var key = Variable.keyFromVariableConfig(aUserInputConfig);

				return key == defaultKey;
			});

			return new Variable(userInputConfig, aDefaultInputConfig);
		});
	};

	Step.prototype.outputs = function() {
		return this.defaultStepConfig.outputs;
	};

	Step.prototype.isVerified = function() {
		var sourceURL = this.sourceURL();

		if (sourceURL === undefined) {
			return undefined;
		}

		var regexpForVerifiedStepSourceURL = new RegExp("^(?:https?:\/\/)?(?:www.)?github\.com\/(?:bitrise-steplib|bitrise-io)\/.+");

		return regexpForVerifiedStepSourceURL.test(sourceURL);
	};

	Step.prototype.requestedVersion = function() {
		if (this.cvs.indexOf("@") == -1) {
			return null;
		}

		return this.version;
	};

	function parameterGetterSetter(step, parameterKey, parameterValue) {
		if (parameterValue === undefined) {
			return step[step.userStepConfig ? "userStepConfig" : "defaultStepConfig"][parameterKey];
		}

		if (!step.defaultStepConfig || parameterValue != step.defaultStepConfig[parameterKey]) {
			step.userStepConfig[parameterKey] = parameterValue;
		}
		else if (step.userStepConfig && step.userStepConfig[parameterKey] !== undefined) {
			delete step.userStepConfig[parameterKey];
		}

		return parameterValue;
	}

	return Step;

});

angular.module("BitriseWorkflowEditor").filter("normalizedStepIconURL", function() {

	return function(step) {
		var defaultStepIconURL = "<%= image_path('step/icon-default.svg') %>";

		if (!step) {
			return defaultStepIconURL;
		}

		var stepIconURL = step.iconURL();

		return stepIconURL ? stepIconURL : defaultStepIconURL;
	};

});

angular.module("BitriseWorkflowEditor").filter("stepSourceCSSClass", function() {

	return function(step) {
		if (step && step.sourceURL) {
			var regexpForGithubStepSourceURL = new RegExp("^(?:https?:\/\/)?(?:www.)?github\.com\/.+");
			if (regexpForGithubStepSourceURL.test(step.sourceURL)) {
				return "github";
			}

			var regexpForBitbucketStepSourceURL = new RegExp("^(?:https?:\/\/)?(?:www.)?bitbucket\.(?:com|org)\/.+");
			if (regexpForBitbucketStepSourceURL.test(step.sourceURL)) {
				return "bitbucket";
			}
			
			var regexpForGitlabStepSourceURL = new RegExp("^(?:https?:\/\/)?(?:www.)?gitlab\.com\/.+");
			if (regexpForGitlabStepSourceURL.test(step.sourceURL)) {
				return "gitlab";
			}
		}

		return "unknown";
	};

});

})();
