(function() {

"use strict";

angular.module("BitriseWorkflowEditor").factory("Trigger", function(stringService) {

	var Trigger = function(type) {
		if (type === undefined) {
			type = "push";
		}

		this.workflow;
		this.type = type;
		this.pushBranchPattern;
		this.pullRequestSourceBranchPattern;
		this.pullRequestTargetBranchPattern;
		this.tagPattern;

		switch (this.type) {
			case "push":
				this.pushBranchPattern = "";

				break;
			case "pull-request":
				this.pullRequestSourceBranchPattern = "";
				this.pullRequestTargetBranchPattern = "";

				break;
			case "tag":
				this.tagPattern = "";

				break;
		}
	};

	Trigger.validateTriggerConfig = function(triggerConfig, workflows) {
		if (!_.isObject(triggerConfig) || angular.isArray(triggerConfig)) {
			throw new TypeError("<%= data[:strings][:trigger][:validation_error_prefix] %><%= data[:strings][:trigger][:trigger_config_not_object] %>");
		}

		if (triggerConfig.workflow === undefined) {
			throw new Error("<%= data[:strings][:trigger][:validation_error_prefix] %><%= data[:strings][:trigger][:workflow_not_defined] %>");
		}
		if (typeof triggerConfig.workflow != "string") {
			throw new Error("<%= data[:strings][:trigger][:validation_error_prefix] %><%= data[:strings][:trigger][:invalid_workflow_id] %>");
		}
		if (!_.find(workflows, {
			id: triggerConfig.workflow
		})) {
			throw new Error("<%= data[:strings][:trigger][:validation_error_prefix] %><%= data[:strings][:trigger][:workflow_not_found] %>");
		}

		var isTypeDefined = false;

		_.each(["push_branch", "pull_request_source_branch", "tag"], function(aTriggerConfigParameterKey) {
			if (triggerConfig[aTriggerConfigParameterKey] === undefined) {
				return;
			}

			if (typeof triggerConfig[aTriggerConfigParameterKey] != "string") {
				throw new TypeError(stringService.stringReplacedWithParameters("<%= data[:strings][:trigger][:validation_error_prefix] %><%= data[:strings][:trigger][:value_not_string] %>", {
					key: aTriggerConfigParameterKey
				}));
			}

			if (isTypeDefined) {
				throw new Error("<%= data[:strings][:trigger][:validation_error_prefix] %><%= data[:strings][:trigger][:multiple_types] %>");
			}

			isTypeDefined = true;
		});

		if (!isTypeDefined) {
			throw new Error("<%= data[:strings][:trigger][:validation_error_prefix] %><%= data[:strings][:trigger][:missing_type] %>");
		}

		if (triggerConfig.pull_request_source_branch !== undefined && typeof triggerConfig.pull_request_target_branch != "string") {
			throw new Error("<%= data[:strings][:trigger][:validation_error_prefix] %><%= data[:strings][:trigger][:missing_pull_request_target_branch] %>");
		}
	};

	Trigger.createFromTriggerConfig = function(triggerConfig, workflows) {
		var trigger;

		if (triggerConfig.push_branch !== undefined) {
			trigger = new Trigger("push");
			trigger.pushBranchPattern = triggerConfig.push_branch;
		}
		else if (triggerConfig.pull_request_source_branch !== undefined || triggerConfig.pull_request_target_branch !== undefined) {
			trigger = new Trigger("pull-request");
			trigger.pullRequestSourceBranchPattern = triggerConfig.pull_request_source_branch;
			trigger.pullRequestTargetBranchPattern = triggerConfig.pull_request_target_branch;
		}
		else if (triggerConfig.tag !== undefined) {
			trigger = new Trigger("tag");
			trigger.tagPattern = triggerConfig.tag;
		}

		trigger.workflow = _.find(workflows, {
			id: triggerConfig.workflow
		});

		return trigger;
	};

	return Trigger;

});

angular.module("BitriseWorkflowEditor").filter("displayNameForTriggerType", function() {

	return function(triggerType) {
		switch (triggerType) {
			case "push":
				return "<%= data[:strings][:triggers][:types][:push] %>";
			case "pull-request":
				return "<%= data[:strings][:triggers][:types][:pull_request] %>";
			case "tag":
				return "<%= data[:strings][:triggers][:types][:tag] %>";
		}
	};

})

})();
