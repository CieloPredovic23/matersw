(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("AppEnvVarsController", function($rootScope, $q, Progress, Variable) {

	var viewModel = this;

	var appConfig;
	viewModel.appEnvVars;
	var envVarEditorLoadedAndReadyDeferred = $q.defer();

	viewModel.loadAppEnvVarsProgress = new Progress();
	viewModel.loadTemplateProgress = new Progress();

	$rootScope.$on("MainController::appConfigLoaded", function(event, _appConfig) {
		appConfig = _appConfig;

		viewModel.appEnvVars = _.map(_appConfig.app.envs, function(anAppEnvVarConfig) {
			return new Variable(angular.copy(anAppEnvVarConfig));
		});

		envVarEditorLoadedAndReadyDeferred.promise.then(configureEnvVarsController);
	});

	$rootScope.$on("MainController::discardChanges", function(event, _appConfig) {
		appConfig = _appConfig;

		viewModel.appEnvVars = _.map(_appConfig.app.envs, function(anAppEnvVarConfig) {
			return new Variable(angular.copy(anAppEnvVarConfig));
		});
		
		envVarEditorLoadedAndReadyDeferred.promise.then(configureEnvVarsController);
	});

	$rootScope.$on("MainController::requestingAppConfigUpdateBeforeSave", function() {
		if (_.any(viewModel.appEnvVars, function(anAppEnvVar) {
			return anAppEnvVar.key().length == 0;
		})) {
			$rootScope.$emit("MainController::appConfigSaveError", new Error("<%= data[:strings][:env_var_editor][:env_var_without_key] %>"));

			return;
		}

		if (!appConfig.app) {
			appConfig.app = {};
		}

		appConfig.app.envs = _.map(viewModel.appEnvVars, function(anEnvVar) {
			return anEnvVar.userVariableConfig;
		});
	});

	$rootScope.$on("EnvVarsController::loadedAndReady", function() {
		envVarEditorLoadedAndReadyDeferred.resolve();
	});

	function configureEnvVarsController() {
		$rootScope.$emit("EnvVarsController::configure", {
			source: "app-env-vars",
			envVars: viewModel.appEnvVars
		});
	}

	viewModel.loadTemplateProgress.start("<%= data[:strings][:env_var_editor][:template_load_inprogress] %>");

	$rootScope.$emit("MainController::menuContentIsLoadedAndReady");

});

})();
