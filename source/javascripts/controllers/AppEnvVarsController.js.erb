(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("AppEnvVarsController", function($scope, $q, Progress, Variable) {

	var viewModel = this;

	viewModel.appEnvVars;
	var appConfigLoadDeferred = $q.defer();

	viewModel.loadAppEnvVarsProgress = new Progress();
	viewModel.loadTemplateProgress = new Progress();

	$scope.$on("MainController::appConfigLoaded", function(event, appConfig) {
		viewModel.appEnvVars = _.map(appConfig.app.envs, Variable.createFromVariableConfig);
		appConfigLoadDeferred.resolve();
	});

	$scope.$on("EnvVarsController::loadedAndReady", function() {
		appConfigLoadDeferred.promise.then(function() {
			$scope.$broadcast("EnvVarsController::configure", {
				source: "app-env-vars",
				envVars: viewModel.appEnvVars
			});
		});
	});

	viewModel.loadTemplateProgress.start("<%= data[:strings][:env_var_editor][:template_load_inprogress] %>");

	$scope.$emit("MainController::menuContentIsLoadedAndReady");

});

})();
