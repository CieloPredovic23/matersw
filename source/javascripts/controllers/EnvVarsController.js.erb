(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("EnvVarsController", function($scope, $rootScope, requestService, Progress, Variable) {

	var viewModel = this;

	var mode;
	var defaultEnvVarConfig = {
		opts: {
			is_expand: true
		}
	};

	viewModel.loadEnvVarsProgress = new Progress();
	viewModel.envVarsBySource;

	$scope.$on("$destroy", $rootScope.$on("MainController::appConfigLoaded", function(event, appConfig) {
		configureWithAppConfig(appConfig);
	}));

	$scope.$on("$destroy", $rootScope.$on("MainController::discardChanges", function(event, appConfig) {
		switch (mode) {
			case "secrets":
				_.first(viewModel.envVarsBySource).envVars = angular.copy(_.first(viewModel.envVarsBySource).savedEnvVars);

				break;
			case "env-vars":
				configureWithAppConfig(appConfig);

				break;
		}
	}));

	viewModel.configureWithMode = function(_mode) {
		mode = _mode;

		switch (mode) {
			case "secrets":
				loadSecrets();

				break;
		}
	};

	function loadSecrets() {
		viewModel.loadEnvVarsProgress.start("<%= data[:strings][:env_vars][:load_progress][:in_progress] %>");

		requestService.getSecrets().then(function(secretConfigs) {
			viewModel.envVarsBySource = [{
				type: "secrets",
				notification: "<%= data[:strings][:env_vars][:secrets][:notification] %>",
				envVars: _.map(secretConfigs, function(aSecretConfig) {
					return new Variable(aSecretConfig);
				})
			}];

			_.first(viewModel.envVarsBySource).savedEnvVars = angular.copy(_.first(viewModel.envVarsBySource).envVars);

			viewModel.loadEnvVarsProgress.success();
		}, function(error) {
			viewModel.loadEnvVarsProgress.error(error);
		});
	}

	function configureWithAppConfig(appConfig) {
		switch (mode) {
			case "secrets":
				break;
			case "env-vars":
				viewModel.envVarsBySource = [];

				if (appConfig.app.envs) {
					viewModel.envVarsBySource.push({
						type: "app",
						warning: "<%= data[:strings][:env_vars][:app][:warning] %>",
						envVars: _.map(appConfig.app.envs, function(anAppEnvVarConfig) {
							return new Variable(anAppEnvVarConfig);
						})
					});
				}

				_.each(appConfig.workflows, function(aWorkflowConfig, aWorkflowID) {
					viewModel.envVarsBySource.push({
						type: "workflow",
						workflowID: aWorkflowID,
						notification: "<%= data[:strings][:env_vars][:workflow][:notification] %>",
						envVars: _.map(aWorkflowConfig.envs, function(anEnvVarConfig) {
							return new Variable(anEnvVarConfig);
						})
					});
				});

				break;
		}

		viewModel.loadEnvVarsProgress.success();
	}

	viewModel.addToEnvVars = function(envVars) {
		var newEnvVar = new Variable({
			"<%= data[:strings][:env_var_editor][:new_default_key] %>": ""
		}, defaultEnvVarConfig);

		envVars.push(newEnvVar);
	};

	viewModel.removeEnvVarFromEnvVars = function(envVar, envVars) {
		var index = _.indexOf(envVars, envVar);

		envVars.splice(index, 1);
	};

	$scope.$on("$destroy", $rootScope.$on("MainController::requestValidationBeforeSave", function() {
		if (_.any(viewModel.envVarsBySource, function(envVarsOfSource) {
			return _.any(envVarsOfSource.envVars, function(anEnvVar) {
				return anEnvVar.key().length == 0;
			});
		})) {
			$rootScope.$emit("MainController::validationError", new Error("<%= data[:strings][:env_var_editor][:env_var_without_key] %>"));
		};
	}));

	$scope.$on("$destroy", $rootScope.$on("SecretsController::saveSecrets", function(event, resolve, reject) {
		requestService.postSecrets(_.find(viewModel.envVarsBySource, {
			type: "secrets"
		}).envVars).then(function() {
			resolve();

			loadSecrets();
		}, function(error) {
			reject(error)
		});
	}));

	$rootScope.$emit("MainController::menuContentIsLoadedAndReady");

});

})();
