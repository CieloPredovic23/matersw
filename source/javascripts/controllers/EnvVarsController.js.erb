(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("EnvVarsController", function($scope, Variable) {

	var viewModel = this;

	var selectedEnvVarLastValidKey;

	viewModel.envVars;
	viewModel.selectedEnvVar = null;
	viewModel.title;
	viewModel.notification;

	$scope.$on("EnvVarsController::configure", function(event, parameters) {
		switch (parameters.source) {
			case "secrets":
				viewModel.title = "<%= data[:strings][:secrets][:title] %>";
				viewModel.notification = "<%= data[:strings][:secrets][:notification] %>";
				
				break;
			case "app-env-vars":
				viewModel.title = "<%= data[:strings][:app_env_vars][:title] %>";
				viewModel.notification = "<%= data[:strings][:app_env_vars][:notification] %>";
				
				break;
			case "workflow-env-vars":
				viewModel.title = "<%= data[:strings][:editor][:env_vars][:title] %>";
				
				break;
		}

		viewModel.envVars = parameters.envVars;
		viewModel.envVarSelected(null);
	});

	viewModel.envVarSelected = function(envVar) {
		if (envVar == viewModel.selectedEnvVar) {
			return;
		}

		if (viewModel.selectedEnvVar && viewModel.selectedEnvVar.key().length == 0) {
			viewModel.selectedEnvVar.key(selectedEnvVarLastValidKey);
		}

		viewModel.selectedEnvVar = envVar;
		selectedEnvVarLastValidKey = viewModel.selectedEnvVar ? viewModel.selectedEnvVar.key() : null;
	};

	viewModel.addNewSelected = function() {
		var newEnvVar = new Variable("<%= data[:strings][:env_var_editor][:new_default_key] %>", "");
		viewModel.envVars.push(newEnvVar);

		viewModel.envVarSelected(newEnvVar);
	};

	viewModel.deleteSelectedEnvVar = function() {
		var index = _.indexOf(viewModel.envVars, viewModel.selectedEnvVar);
		
		viewModel.selectedEnvVar = null;
	};

	$scope.$on("$destroy", function() {
		viewModel.envVarSelected(null);
	});

	$scope.$emit("EnvVarsController::loadedAndReady");

});

})();
