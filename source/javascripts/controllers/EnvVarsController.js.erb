(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("EnvVarsController", function($scope, $rootScope, Variable) {

	var viewModel = this;

	var defaultEnvVarConfig = {
		opts: {
			is_expand: true
		}
	};

	viewModel.title;
	viewModel.notification;
	viewModel.envVars;
	viewModel.selectedEnvVar = null;

	$scope.$on("$destroy", $rootScope.$on("EnvVarsController::configure", function(event, parameters) {
		switch (parameters.source) {
			case "secrets":
				viewModel.title = "<%= data[:strings][:secrets][:title] %>";
				viewModel.notification = "<%= data[:strings][:secrets][:notification] %>";
				
				break;
			case "app-env-vars":
				viewModel.title = "<%= data[:strings][:app_env_vars][:title] %>";
				viewModel.notification = "<%= data[:strings][:app_env_vars][:notification] %>";
				
				break;
			case "workflow-env-vars":
				viewModel.title = "<%= data[:strings][:workflows][:env_vars][:title] %>";
				
				break;
		}

		viewModel.envVars = parameters.envVars;
		_.each(viewModel.envVars, function(anEnvVar) {
			anEnvVar.defaultVariableConfig = defaultEnvVarConfig;
		});
		
		viewModel.envVarSelected(null);
	}));

	viewModel.envVarSelected = function(envVar) {
		if (envVar == viewModel.selectedEnvVar) {
			return;
		}

		viewModel.selectedEnvVar = envVar;
	};

	viewModel.addNewSelected = function() {
		var newEnvVar = new Variable({
			"<%= data[:strings][:env_var_editor][:new_default_key] %>": ""
		}, defaultEnvVarConfig);
		viewModel.envVars.push(newEnvVar);

		viewModel.envVarSelected(newEnvVar);
	};

	viewModel.deleteSelectedEnvVar = function() {
		var index = _.indexOf(viewModel.envVars, viewModel.selectedEnvVar);

		viewModel.envVars.splice(index, 1);
		
		viewModel.selectedEnvVar = null;
	};

	$scope.$on("$destroy", $rootScope.$on("MainController::requestValidationBeforeSave", function() {
		if (_.any(viewModel.envVars, function(anEnvVar) {
			return anEnvVar.key().length == 0;
		})) {
			$rootScope.$emit("MainController::validationError", new Error("<%= data[:strings][:env_var_editor][:env_var_without_key] %>"));
		}
	}));

	$scope.$on("$destroy", function() {
		viewModel.envVarSelected(null);
	});

	$rootScope.$emit("EnvVarsController::loadedAndReady");

});

})();
