(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("EnvVarsController", function($scope, communicationHelper, Variable) {

	var viewModel = this;

	var selectedEnvVarLastValidKey;

	viewModel.envVars;
	viewModel.selectedEnvVar = null;
	viewModel.title;
	viewModel.notification;

	communicationHelper.readMessage("configureEnvVarsController").then(function(parameters) {
		switch (parameters.source) {
			case "secrets":
				viewModel.title = "<%= data[:strings][:env_var_editor][:secrets][:title] %>";
				viewModel.notification = "<%= data[:strings][:env_var_editor][:secrets][:notification] %>";
				
				break;
			case "app-env-vars":
				viewModel.title = "<%= data[:strings][:env_var_editor][:app_env_vars][:title] %>";
				viewModel.notification = "<%= data[:strings][:env_var_editor][:app_env_vars][:notification] %>";
				
				break;
			case "workflow-env-vars":
				viewModel.title = "<%= data[:strings][:env_var_editor][:workflow_env_vars][:title] %>";
				viewModel.envVars = parameters.envVars;
				
				break;
		}
	});

	viewModel.envVarSelected = function(envVar) {
		if (envVar == viewModel.selectedEnvVar) {
			return;
		}

		if (viewModel.selectedEnvVar && viewModel.selectedEnvVar.key.length == 0) {
			viewModel.selectedEnvVar.key = selectedEnvVarLastValidKey;
		}

		viewModel.selectedEnvVar = envVar;
		selectedEnvVarLastValidKey = viewModel.selectedEnvVar ? viewModel.selectedEnvVar.key : null;
	};

	viewModel.addNewSelected = function() {
		var newEnvVar = new Variable("<%= data[:strings][:env_var_editor][:new_default_key] %>", "");
		viewModel.envVars.push(newEnvVar);

		viewModel.envVarSelected(newEnvVar);
	};

	viewModel.deleteSelectedEnvVar = function() {
		var index = _.indexOf(viewModel.envVars, viewModel.selectedEnvVar);
		
		viewModel.selectedEnvVar = null;
	};

	$scope.$on("$destroy", function() {
		viewModel.envVarSelected(null);
	});

});

})();
