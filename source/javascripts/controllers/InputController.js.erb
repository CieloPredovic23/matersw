(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("InputController", function($scope, $rootScope, Variable) {

	var viewModel = this;

	var selectedStep;
	var defaultInputConfig;

	viewModel.input;

	viewModel.init = function(_selectedStep, _defaultInputConfig) {
		selectedStep = _selectedStep;
		defaultInputConfig = _defaultInputConfig;

		var userInputConfig = selectedStep.userStepConfig ? _.find(selectedStep.userStepConfig.inputs, function(aUserInputConfig) {
			return Variable.keyFromVariableConfig(aUserInputConfig) == Variable.keyFromVariableConfig(defaultInputConfig);
		}) : null;

		viewModel.input = new Variable(userInputConfig, defaultInputConfig);

		$scope.$on("$destroy", $scope.$watch(function() {
			return !viewModel.input.userVariableConfig || _.isEmpty(angular.copy(viewModel.input.userVariableConfig));
		}, function(isUserInputConfigEmptyNow, wasUserInputConfigEmptyBefore) {
			if (isUserInputConfigEmptyNow === true && wasUserInputConfigEmptyBefore === false) {
				var indexOfUserInputConfig = _.findIndex(selectedStep.userStepConfig.inputs, function(aUserInputConfig) {
					return Variable.keyFromVariableConfig(aUserInputConfig) == viewModel.input.key();
				});

				selectedStep.userStepConfig.inputs.splice(indexOfUserInputConfig, 1);

				if (_.isEmpty(angular.copy(selectedStep.userStepConfig.inputs))) {
					delete selectedStep.userStepConfig["inputs"];
				}

				if (_.isEmpty(angular.copy(selectedStep.userStepConfig))) {
					selectedStep.userStepConfig = null;
				}
			}

			if (isUserInputConfigEmptyNow === false && wasUserInputConfigEmptyBefore === true) {
				if (!selectedStep.userStepConfig) {
					selectedStep.userStepConfig = {};
				}

				if (!selectedStep.userStepConfig.inputs) {
					selectedStep.userStepConfig.inputs = [];
				}

				var indexOfUserInputConfig = _.findIndex(selectedStep.userStepConfig.inputs, function(aUserInputConfig) {
					return Variable.keyFromVariableConfig(aUserInputConfig) == viewModel.input.key();
				});

				if (indexOfUserInputConfig != -1) {
					selectedStep.userStepConfig.inputs.splice(indexOfUserInputConfig, 1);
				}

				selectedStep.userStepConfig.inputs.push(viewModel.input.userVariableConfig);
			}
		}));
	};

	viewModel.inputSelected = function(input) {
		$rootScope.$emit("InputController::inputSelected", input);
	};

	viewModel.inputValueBlurred = function(event) {
		$rootScope.$emit("InsertVariableController::setInsertStartEndPosition", event.target.selectionStart, event.target.selectionEnd);
	};

	viewModel.insertVariableSelected = function() {
		$rootScope.$emit("InsertVariableController::showInsertVariablePopupForTargetInput", viewModel.input);
	};

});

})();
