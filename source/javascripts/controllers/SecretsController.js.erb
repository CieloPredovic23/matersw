(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("SecretsController", function($location, $q, $http, routeHelper, communicationHelper, Progress, Variable) {

	var viewModel = this;

	viewModel.secrets;
	var savedSecrets;

	viewModel.loadSecretsProgress = new Progress();
	viewModel.loadTemplateProgress = new Progress();

	function loadSecrets() {
		viewModel.loadSecretsProgress.start("<%= data[:strings][:secrets][:load_progress][:loading] %>");

		var appSlug = $location.search().app_slug;
		var apiToken = $location.search().api_token;
		var requestURL = routeHelper.replacedRoute("<%= secrets_get_path %>", {
			app_slug: appSlug,
			api_token: apiToken
		});

		$q(function(resolve, reject) {
			$http.get(requestURL).then(function(response) {
				viewModel.secrets = [];

				_.each(response.data.envs, function(aSecretConfig) {
					var secret = Variable.createFromVariableConfig(aSecretConfig);
					viewModel.secrets.push(secret);
				});

				savedSecrets = angular.copy(viewModel.secrets);

				resolve();
			}, function(response) {
				if (!response || !response.data) {
					reject(new Error("<%= data[:strings][:secrets][:load_progress][:default_error] %>"));

					return;
				}

				reject(new Error("<%= data[:strings][:secrets][:load_progress][:error_prefix] %> " + response.data));
			});
		}).then(function() {
			viewModel.loadSecretsProgress.success();

			communicationHelper.addMessage("configureEnvVarsController", {
				source: "secrets",
				envVars: viewModel.secrets
			});
		}, function(error) {
			viewModel.loadSecretsProgress.error(error);
		});
	}

	loadSecrets();
	viewModel.loadTemplateProgress.start("<%= data[:strings][:env_var_editor][:template_load_inprogress] %>");

});

})();
