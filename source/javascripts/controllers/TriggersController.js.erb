(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("TriggersController", function($scope, $rootScope, Trigger, Workflow) {

	var viewModel = this;

	viewModel.appConfig;
	viewModel.workflows;

	$scope.triggerTypes = [{
		id: 'push',
		triggers: undefined
	}, {
		id: 'pull-request',
		triggers: undefined
	}, {
		id: 'tag',
		triggers: undefined
	}];
	viewModel.selectedTriggerType;

	viewModel.selectedTrigger = null;
	viewModel.editedTrigger;
	viewModel.newTriggerIndex;

	$scope.$on("$destroy", $rootScope.$on("MainController::appConfigLoaded", function(event, appConfig) {
		configureWithAppConfig(appConfig);
	}));

	$scope.$on("$destroy", $rootScope.$on("MainController::discardChanges", function(event, appConfig) {
		configureWithAppConfig(appConfig);
	}));

	$scope.$on("$destroy", $scope.$watch("triggerTypes", function(triggerTypes) {
		if (!viewModel.appConfig) {
			return;
		}

		viewModel.appConfig.trigger_map = [];

		_.each(triggerTypes, function(aTriggerType) {
			_.each(aTriggerType.triggers, function(aTrigger) {
				viewModel.appConfig.trigger_map.push(aTrigger.triggerConfig);
			});
		});

		if (_.isEmpty(viewModel.appConfig.trigger_map)) {
			delete viewModel.appConfig["triggers"];
		}
	}, true));

	function configureWithAppConfig(appConfig) {
		viewModel.appConfig = appConfig;
		viewModel.workflows = _.map(viewModel.appConfig.workflows, function(aWorkflowConfig, workflowID) {
			return new Workflow(workflowID, aWorkflowConfig);
		});

		_.each($scope.triggerTypes, function(aTriggerType) {
			aTriggerType.triggers = [];
		});

		_.each(viewModel.appConfig.trigger_map, function(triggerConfig) {
			var trigger = new Trigger(triggerConfig);

			_.find($scope.triggerTypes, {
				id: trigger.type()
			}).triggers.push(trigger);
		});

		viewModel.triggerTypeSelected(_.first($scope.triggerTypes));
	}

	viewModel.triggerTypeSelected = function(triggerType) {
		if (triggerType !== undefined) {
			viewModel.selectedTriggerType = triggerType;
			viewModel.triggerSelected(null);
		}

		return viewModel.selectedTriggerType;
	};

	viewModel.triggerSelected = function(trigger) {
		viewModel.newTriggerIndex = undefined;
		viewModel.selectedTrigger = trigger;
		viewModel.editedTrigger = viewModel.selectedTrigger;
	};

	viewModel.deleteTriggerSelected = function(trigger) {
		var index = _.indexOf(viewModel.selectedTriggerType.triggers, trigger);
		viewModel.selectedTriggerType.triggers.splice(index, 1);

		viewModel.triggerSelected(null);
	};

	viewModel.addTriggerSelectedAtIndex = function(index) {
		var newTrigger = new Trigger();
		newTrigger.type(viewModel.selectedTriggerType.id);

		viewModel.editedTrigger = newTrigger;
		viewModel.newTriggerIndex = index;
	};

	viewModel.triggerEditFinished = function() {
		var triggerType = _.find($scope.triggerTypes, {
			id: viewModel.editedTrigger.type()
		});

		var index;

		if (viewModel.selectedTrigger) {
			index = _.indexOf(triggerType.triggers, viewModel.selectedTrigger);
			viewModel.selectedTriggerType.triggers.splice(_.indexOf(viewModel.selectedTriggerType.triggers, viewModel.selectedTrigger), 1);
		}
		else {
			index = viewModel.newTriggerIndex;
		}

		triggerType.triggers.splice(index, 0, viewModel.editedTrigger);

		viewModel.triggerSelected(null);
	};

	viewModel.triggerEditCancelled = function() {
		viewModel.triggerSelected(null);
	};

	$scope.$on("$destroy", $rootScope.$on("MainController::requestValidationBeforeSave", function() {
		if (_.any(viewModel.triggerTypes, function(aTriggerType) {
			return _.any(viewModel.triggerType.triggers, function(aTrigger) {
				return !_.find(viewModel.workflows, {
					id: aTrigger.workflowID()
				});
			});
		})) {
			$rootScope.$emit("MainController::validationError", new Error("<%= data[:strings][:triggers][:trigger_with_invalid_workflow] %>"));
		}
	}));

	$rootScope.$emit("MainController::menuContentIsLoadedAndReady");

});

})();
