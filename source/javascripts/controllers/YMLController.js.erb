(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("YMLController", function($scope, $rootScope, $q, requestService, Progress) {

	var viewModel = this;

	viewModel.appConfigYML;
	var savedAppConfigYML;
	viewModel.loadAppConfigYMLProgress = new Progress();
	viewModel.downloadAppConfigYMLPath = requestService.mode == "website" ? requestService.appConfigYMLDownloadPath() : null;

	function loadAppConfigYML() {
		viewModel.loadAppConfigYMLProgress.start("<%= data[:strings][:yml][:load_progress][:loading] %>");

		var canceler = $q.defer();

		$scope.$on("$destroy", function() {
			canceler.resolve();
		});

		requestService.getAppConfigYML({
			timeout: canceler.promise
		}).then(function(appConfigYML) {
			viewModel.appConfigYML = appConfigYML;
			savedAppConfigYML = appConfigYML;

			viewModel.loadAppConfigYMLProgress.success();
		}, function(error) {
			viewModel.loadAppConfigYMLProgress.error(error);
		});
	}

	$scope.$on("$destroy", $rootScope.$on("YMLController::saveAppConfigYML", function(event, resolve, reject) {
		var canceler = $q.defer();

		$scope.$on("$destroy", function() {
			canceler.resolve();
		});

		requestService.postAppConfigYML(viewModel.appConfigYML, {
			timeout: canceler.promise
		}).then(function(appConfigYML) {
			resolve();

			loadAppConfigYML();
		}, function(error) {
			reject(error)
		});
	}));

	$scope.$on("$destroy", $rootScope.$on("MainController::discardChanges", function() {
		viewModel.appConfigYML = savedAppConfigYML;
	}));

	loadAppConfigYML();

});

})();
