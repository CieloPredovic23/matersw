(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("ProvProfileController", function($q, $timeout, requestService, stringService, Popup, Progress, ProvProfile) {

	var viewModel = this;

	var provProfilesReloadIntervalInSeconds = 2;

	viewModel.provProfiles;
	viewModel.loadProvProfilesProgress = new Progress();
	viewModel.uploadProvProfileProgress = new Progress();
	viewModel.deleteProvProfileProgress = new Progress();
	viewModel.provProfiles;
	viewModel.uploadedProvProfile = new ProvProfile();
	viewModel.provProfileUploader;

	function loadProvProfiles(shouldClearPreviousLoad) {
		viewModel.loadProvProfilesProgress.start("<%= data[:strings][:code_signing][:prov_profile][:load_progress][:in_progress] %>");
		if (viewModel.uploadProvProfileProgress.isIdle && viewModel.uploadProvProfileProgress.statusMessage !== null) {
			viewModel.uploadProvProfileProgress.reset();
		}

		if (shouldClearPreviousLoad === undefined) {
			shouldClearPreviousLoad = false;
		}

		if (shouldClearPreviousLoad) {
			viewModel.provProfiles = undefined;
		}

		requestService.getProvProfiles().then(function(provProfileDatas) {
			viewModel.provProfiles = _.map(provProfileDatas, function(aProvProfileData) {
				var provProfile = new ProvProfile();

				provProfile.databaseID = aProvProfileData.databaseID;
				provProfile.isProcessed = aProvProfileData.isProcessed;
				provProfile.expiringDownloadURL = aProvProfileData.expiringDownloadURL;

				return provProfile;
			});

			viewModel.loadProvProfilesProgress.success();

			if (_.find(viewModel.provProfiles, {
				isProcessed: false
			})) {
				$timeout(function() {
					loadProvProfiles();
				}, provProfilesReloadIntervalInSeconds * 1000);
			}
		}, function(error) {
			viewModel.loadProvProfilesProgress.error(error);
		});
	};

	viewModel.uploadProvProfile = function() {
		viewModel.uploadProvProfileProgress.start("<%= data[:strings][:code_signing][:prov_profile][:upload_progress][:in_progress] %>");

		$q(function(resolve, reject) {
			viewModel.uploadedProvProfile.upload().then(function() {
				resolve();
			}, function(error) {
				reject(error);
			});
		}).then(function() {
			Popup.showSuccessPopup("<%= data[:strings][:code_signing][:prov_profile][:upload_progress][:success] %>");
			viewModel.uploadProvProfileProgress.success();

			viewModel.uploadedProvProfile = new ProvProfile();
			loadProvProfiles(true);
		}, function(error) {
			viewModel.uploadProvProfileProgress.error(error);
		});
	};

	viewModel.deleteProvProfile = function(provProfile) {
		viewModel.deleteProvProfileProgress.start("<%= data[:strings][:code_signing][:prov_profile][:delete_progress][:in_progress] %>");
		if (viewModel.uploadProvProfileProgress.isIdle && viewModel.uploadProvProfileProgress.statusMessage !== null) {
			viewModel.uploadProvProfileProgress.reset();
		}

		provProfile.delete().then(function() {
			Popup.showSuccessPopup("<%= data[:strings][:code_signing][:prov_profile][:delete_progress][:success] %>");
			viewModel.deleteProvProfileProgress.success();

			loadProvProfiles(true);
		}, function(error) {
			viewModel.deleteProvProfileProgress.error(error);
		});
	};

	loadProvProfiles();

});

})();
