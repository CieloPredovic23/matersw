(function() {

"use strict";

angular.module("BitriseWorkflowEditor").controller("StackController", function($scope, $rootScope, $q, stringService, requestService, appService, Progress, Workflow, Stack) {

	var viewModel = this;

	viewModel.workflows;
	viewModel.stacks;
	viewModel.defaultStack;

	viewModel.init = function() {
		configureWithAppConfig();
	};

	$scope.$on("$destroy", $rootScope.$on("MainController::changesDiscarded", function() {
		configureWithAppConfig();
	}));

	function configureWithAppConfig() {
		viewModel.workflows = _.map(appService.appConfig.workflows, function(aWorkflowConfig, workflowID) {
			return new Workflow(workflowID, aWorkflowConfig);
		});
		viewModel.stacks = appService.stacks;
		viewModel.defaultStack = appService.stack;
	}

	$scope.$watch(function() {
		return viewModel.defaultStack;
	}, function(newStack) {
		appService.stack = newStack;
	});

	viewModel.aboutStack = function(stack) {
		return stringService.stringReplacedWithParameters("<%= data[:strings][:stack][:about_stack] %>", {
			stack_name: stack.name
		});
	};

	viewModel.stackGetterSetterForWorkflow = function(workflow) {
		return function(stack) {
			if (!appService.stacks || !appService.stack) {
				return undefined;
			}

			return workflow.stack(stack, appService.stacks, appService.stack);
		};
	};

});

})();
