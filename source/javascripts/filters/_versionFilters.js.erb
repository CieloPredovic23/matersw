"use strict";

var VERSION_LABEL_KEY = "label";

angular.module("BitriseWorkflowEditor")
    .filter("versionLabel", function() {
        return function(version) {
            var label = version && version[VERSION_LABEL_KEY];
            return !label ? "#{ data[:strings][:workflows][:steps][:always_latest] }" : label;
        };
    })
    .filter("stepVersions", ["stepSourceService", function(stepSourceService) {
        var shouldInsertLatest = function(step) {
            return step.isLibraryStep();
        };

        var versionList = function(versions, disabled) {
            return _.map(versions, function(ver) {
                var versionModel = {disabled: disabled };
                versionModel[VERSION_LABEL_KEY] = ver;
                return versionModel;
            });
        };

        var baseVersions = function(step) {
            var baseVersions = shouldInsertLatest(step) ? _.uniq([null, step.version]) : [step.version];
            return versionList(baseVersions, true);
        };

        return function(step) {
            var bases = baseVersions(step);
            var wildcards = versionList(stepSourceService.versionsOfStep(step), false);

            return _.union(bases, wildcards);
        };
    }]);
