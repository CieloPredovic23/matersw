(function() {
	"use strict";

	angular.module("BitriseWorkflowEditor").service("stepLibSearchService", function($q) {
		var stepLib = new StepLib(
			"<%= data[:constants][:algolia][:appID] %>",
			"<%= data[:constants][:algolia][:apiKey] %>"
		);

		var stepLibSearchService = {};

		stepLibSearchService.list = function(stepCVSs, includeInputs, attributesToRetrieve) {
			attributesToRetrieve = attributesToRetrieve || ["*"];

			return stepLib
				.list({
					stepIds: stepCVSs,
					includeInputs: includeInputs,
					algoliaOptions: {
						attributesToRetrieve: attributesToRetrieve
					}
				})
				.then(convertSteps)
				.catch(function(err) {
					return $q.reject(err);
				});
		};

		stepLibSearchService.getStepVersions = function(stepId, attributesToRetrieve) {
			attributesToRetrieve = attributesToRetrieve || ["*"];

			return stepLib
				.list({
					query: stepId,
					includeInputs: true,
					algoliaOptions: {
						attributesToRetrieve: attributesToRetrieve
					}
				})
				.then(convertSteps)
				.then(function(stepObj) {
					return stepObj[stepId];
				})
				.catch(function(err) {
					return $q.reject(err);
				});
		};

		function convertSteps(steps) {
			return steps.reduce(function(stepObj, stepVersion) {
				var versions = (stepObj[stepVersion.id] || {}).versions || {};
				versions[stepVersion.version] = Object.assign({}, stepVersion, stepVersion.info);

				var step = {
					info: stepVersion.info,
					versions: versions
				};

				return Object.assign({}, stepObj, { [stepVersion.id]: step });
			}, {});
		}

		return stepLibSearchService;
	});
})();
