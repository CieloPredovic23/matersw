(function() {
	"use strict";

	angular.module("BitriseWorkflowEditor").factory("stepLibSearchService", function($q) {
		var stepLib = new StepLib(
			"<%= data[:constants][:algolia][:appID] %>",
			"<%= data[:constants][:algolia][:apiKey] %>"
		);

		var stepLibSearchService = {};

		stepLibSearchService.list = function(stepCVSs, includeInputs, attributesToRetrieve) {
			attributesToRetrieve = attributesToRetrieve || ["*"];

			return stepLib
				.list({
					stepIds: stepCVSs,
					includeInputs: includeInputs,
					algoliaOptions: {
						attributesToRetrieve: attributesToRetrieve
					}
				})
				.then(function(steps) {
					return steps.reduce(function(stepObj, stepVersion) {
						var versions = (stepObj[stepVersion.id] || {}).versions || {};
						versions[stepVersion.version] = Object.assign({}, stepVersion, stepVersion.info);

						var step = {
							info: stepVersion.info,
							versions: versions
						};

						return Object.assign({}, stepObj, { [stepVersion.id]: step });
					}, {});
				})
				.catch(function(err) {
					return $q.reject(err);
				});
		};

		return stepLibSearchService;
	});
})();
